# https://docs.microsoft.com/en-us/azure/devops/pipelines/ecosystems/kubernetes/deployment-strategies?view=azure-devops#canary-deployments-for-kubernetes
# https://docs.microsoft.com/en-us/azure/devops/pipelines/ecosystems/kubernetes/bake?view=azure-devops
# https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/deploy/kubernetes-manifest?view=azure-devops 
# end-to-end https://docs.microsoft.com/en-us/azure/devops/pipelines/ecosystems/kubernetes/canary-demo?view=azure-devops&tabs=yaml 
trigger: none

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: Deployment
    displayName: Deployment to AKS cluster (miferrac ns)
    jobs:
      - deployment: canaryDeployment
        displayName: Canary Deployment
        strategy:
          canary:
            increments: [10,20]
            preDeploy:
              steps:
              - checkout: self
              - task: KubernetesManifest@0
                name: bake # important, to be referenced later.
                inputs:
                  action: 'bake'
                  namespace: 'miferrac'
                  helmChart: 'samples/BikeSharingApp/charts'
                  releaseName: 'miferrac-bike'
                  overrides: |
                    bikes.image.tag $(Build.BuildId)
                    billing.image.tag $(Build.BuildId)
                displayName: bake helm chart
            deploy:
              steps: 
              - task: KubernetesManifest@0
                inputs:
                  action: 'deploy'
                  kubernetesServiceConnection: 'miferrac-expertdaysakscluster-miferrac-1613077274355'
                  namespace: 'miferrac'
                  strategy: 'canary'
                  percentage: '$(strategy.increment)'
                displayName: deploy app updates
            postRouteTraffic: 
              pool: server
              steps:
              - task: ManualValidation@0
                inputs:
                  notifyUsers: 'miferrac@microsoft.com'
                  instructions: 'check the telemetry'
                displayName: Validate
            on: 
              failure:
                steps:
                  - task: KubernetesManifest@0
                    inputs:
                      action: 'reject'
                      kubernetesServiceConnection: 'miferrac-expertdaysakscluster-miferrac-1613077274355'
                      namespace: 'miferrac'
                      strategy: 'canary'
                      manifests: '$(bake.manifestsBundle)'
              success:
                steps:
                  - task: KubernetesManifest@0
                    inputs:
                      action: 'promote'
                      kubernetesServiceConnection: 'miferrac-expertdaysakscluster-miferrac-1613077274355'
                      namespace: 'miferrac'
                      strategy: 'canary'
                      manifests: '$(bake.manifestsBundle)'